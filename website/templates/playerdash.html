{% extends "base.html" %} {% block title %}Home{% endblock %} 
{% block content%} 

<meta name="csrf-token" content="{{ csrf_token() }}">


<body style="background-image: none;" class="light-mode">

<div class="container mt-4">
  <div class="row">
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Notifications</h5>

            <table id="notificationsTable" class="table table-striped" style="width:100%">
              <thead>
                  <tr>
                      <th>Date</th>
                      <th>Sender</th>
                      <th>Comment</th>
                      <th>View</th>
                  </tr>
              </thead>
              <tbody>
                  {% for notification in user_notifications %}
                  <tr id="notificationRow_{{ notification.id }}">
                      <td>{{ notification.timestamp.strftime('%d-%m-%Y') }}</td>
                      <td>{{ notification['sender_name'] }}</td>
                      <td>{{ notification.comment[:10] + '...' if notification.comment|length > 210 else notification.comment }}</td>
                      <td><button type="button" class="btn pink-btn btn-notifications" data-notification-id="{{ notification.id }}" data-sender-id="{{ notification.sender_id }}" data-date="{{ notification.timestamp }}" data-name="{{ notification.sender_name }}" data-message="{{ notification.comment }}" onclick="openModal(this)">View</button></td>
                    </tr>
                  {% endfor %}
              </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-body">
          <!-- <h5 class="card-title">Player ratings for: {{ current_user.Forename }}</h5> -->
          <h5 class="card-title">Coach Ratings Over Time</h5>
          <!-- Check these for testing purposes<br/><br/>
          {{user_notifications}}<br/><br/>
          {{datasets}}<br/><br/>
          {{players_rating_data}}<br/><br/>
          {{categories}}<br/><br/>
          {{ratings_query}} -->
          

          <div id="chart-container">
            <canvas id="userRatingsChart" ></canvas>
          </div>


        </div>
      </div>
    </div>
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Latest Coach Ratings</h5>
          <table id="example" class="table table-striped" style="width:100%">
              <tr>
                  <th>Category</th>
                  <th>Value ( / 10)</th>
              </tr>
              {% for rating, date, category in filtered_data %}
                  <tr>
                      <!-- need to figure out here how to present the LATEST/MOST RECENT scores per category -->
                      <td>{{ category }}</td>
                      <td>{{ rating }}</td>
                  </tr>
              {% endfor %}
          </table>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- MODAL -->
<sl-dialog id="replyModal" label="Notification Details">
  <span class="bold-text">Date|Time: </span><span id="notificationDate"></span></br>
  <span class="bold-text">Sender: </span><span id="notificationSender"></span></br>
  <span class="bold-text">Message:</span></br><span id="notificationMessage"></span></br></br>
  <form id="replyForm" method="POST" action="{{ url_for('player.reply_to_notification') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="original_notification_id" id="originalNotificationId">
    <input type="hidden" name="receiver_id" id="receiverId">
    <sl-textarea name="reply_message" placeholder="Your reply..."></sl-textarea></br>
    <button type="submit" class="btn pink-btn btn-notifications">Send Reply</button>
  </form>
</sl-dialog>



<script>
  // Python data structure (players_rating_data) passed from the server
  // const players_rating_data = {{players_rating_data}}
  const players_rating_data = {{ players_rating_data | tojson | safe }};
  // Extracting data from players_rating_data
  const labels = players_rating_data[0].Date;
  const datasets = players_rating_data.map(entry => ({
      label: entry.Category,
      data: entry.Value,
      fill: false,
      borderColor: '#' + (Math.random().toString(16) + '000000').substring(2, 8) // Random color
  }));

  // Create the chart
  const ctx = document.getElementById('userRatingsChart').getContext('2d');
  const myChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: labels,
          datasets: datasets
      },
      options: {
        responsive: true,
          maintainAspectRatio: false,
          aspectRatio: 0.9, // Set a custom aspect ratio (e.g., 2:1)
          scales: {
              y: {
                  min: 0,
                  max: 10,
                  ticks: {
                      stepSize: 1
                  }
              }
          }
      }
  });
</script>

<script>
  $(document).ready( function () {
      $('#notificationsTable').DataTable();
  } );
</script>


<script>
  function openModal(button) {
    const notificationId = button.getAttribute('data-notification-id');
    const senderId = button.getAttribute('data-sender-id');
    const message = button.getAttribute('data-message');
    const date = button.getAttribute('data-date');
    const name = button.getAttribute('data-name'); // This assumes you're setting data-name attribute in your button

    // Set the content in your modal
    document.getElementById('notificationMessage').textContent = message;
    document.getElementById('notificationDate').textContent = date;
    document.getElementById('notificationSender').textContent = name;
    document.getElementById('originalNotificationId').value = notificationId;
    document.getElementById('receiverId').value = senderId;

    document.querySelector('#replyModal').show();

    // Fetch request to mark the notification as read
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch(`/mark-notification-read/${notificationId}`, {
      method: 'POST',
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({}) // No need to send data, but the server might expect a JSON body
    })
    .then(response => {
      if (response.ok) {
        console.log("Notification marked as read");
        //remove row from the table
        document.getElementById(`notificationRow_${notificationId}`).remove();
      } else {
        console.error('Failed to mark notification as read');
      }
    });
  }
</script>

  


{% endblock %}